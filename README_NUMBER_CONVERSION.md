# Улучшение произношения чисел в ElevenLabs для русского языка

## Описание проблемы

ElevenLabs API часто плохо читает цифры на русском языке, особенно денежные суммы. Это связано с тем, как движок обрабатывает числовые значения в тексте.

## Решение

Реализован улучшенный `TextPreprocessor` класс, который автоматически преобразует числа в слова на русском языке перед отправкой текста в ElevenLabs API.

## Установка зависимостей

```bash
pip install num2words
```

Или обновите requirements.txt:

```bash
pip install -r requirements.txt
```

## Функциональность

### 1. Преобразование простых чисел
- `123` → `сто двадцать три`
- `1000` → `одна тысяча`
- `42` → `сорок два`

### 2. Преобразование денежных сумм
- `744 рубля` → `семьсот сорок четыре рубля`
- `1000,50 рублей` → `одна тысяча рублей 50 копеек`
- `1500,01 рубля` → `одна тысяча пятьсот рублей одна копейка`

### 3. Автоматическое определение форм слов
- Правильные формы: `1 рубль`, `2 рубля`, `5 рублей`
- Правильные формы: `1 копейка`, `2 копейки`, `5 копеек`

### 4. Обработка смешанного текста
- `Заказ №123 на сумму 2500,75 рублей` → `Заказ №сто двадцать три на сумму две тысячи пятьсот рублей 75 копеек`

## Использование

### Автоматическое использование
Улучшенный препроцессор автоматически применяется в функции `text_to_speech_elevenlabs()`:

```python
# Текст автоматически обрабатывается перед отправкой в ElevenLabs
audio, error = await text_to_speech_elevenlabs("Цена 744,94 рубля")
```

### Ручное использование
```python
from main import TextPreprocessor

preprocessor = TextPreprocessor()
processed_text = preprocessor.preprocess("Цена 744,94 рубля")
# Результат: "Цена семьсот сорок четыре рубля 94 копейки"
```

## Тестирование

Запустите тест для проверки работы:

```bash
python test_number_conversion.py
```

## Конфигурация

### Настройки ElevenLabs
В `main.py` настроены оптимальные параметры для русского языка:

```python
ELEVENLABS_MODEL_ID = "eleven_multilingual_v2"  # Многоязычная модель
ELEVENLABS_MALE_VOICE_ID = "pNInz6obpgDQGcFmaJgB"  # Голос Adam

voice_settings=VoiceSettings(
    stability=0.0,           # Максимальная гибкость
    similarity_boost=1.0,    # Максимальное сходство с голосом
    style=0.0,               # Нейтральный стиль
    use_speaker_boost=True,  # Улучшение качества голоса
)
```

## Логирование

Препроцессор логирует все преобразования:

```
INFO - Текст препроцессирован: 25 -> 45 символов
INFO - Исходный текст: 'Цена 744,94 рубля...'
INFO - Обработанный текст: 'Цена семьсот сорок четыре рубля 94 копейки...'
```

## Обратная совместимость

- Если библиотека `num2words` не установлена, препроцессор работает в базовом режиме
- Все существующие функции продолжают работать без изменений
- Добавлено логирование для отслеживания преобразований

## Преимущества

1. **Улучшенное произношение** - числа читаются естественно на русском языке
2. **Автоматическая обработка** - не требует ручного изменения текста
3. **Гибкость** - поддерживает различные форматы чисел и валют
4. **Производительность** - минимальные накладные расходы
5. **Надежность** - graceful fallback при ошибках

## Примеры результатов

| Исходный текст | Обработанный текст |
|----------------|-------------------|
| `Цена 744 рубля` | `Цена семьсот сорок четыре рубля` |
| `Сумма 1000,50 рублей` | `Сумма одна тысяча рублей 50 копеек` |
| `Заказ №42` | `Заказ №сорок два` |
| `Время 15:30` | `Время пятнадцать:тридцать` |

## Поддержка

При возникновении проблем:
1. Проверьте установку библиотеки `num2words`
2. Убедитесь, что текст содержит числа в поддерживаемом формате
3. Проверьте логи для диагностики
4. Убедитесь, что используется многоязычная модель ElevenLabs
